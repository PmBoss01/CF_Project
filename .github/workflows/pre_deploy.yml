
name: Pre-Deployment Checks

on:
  workflow_dispatch:
    inputs:
      run_unit_test:
        description: 'Run Unit Tests'
        required: false
        type: boolean
        default: false
      run_security_scan:
        description: 'Run Security Scan'
        required: false
        type: boolean
        default: false
      run_integration_test:
        description: 'Run Integration Tests'
        required: false
        type: boolean
        default: false
      run_iac_lint:
        description: 'Run IaC Linting'
        required: false
        type: boolean
        default: false
      run_iac_validate:
        description: 'Run IaC Validation'
        required: false
        type: boolean
        default: false

jobs:
  iac-checks:
    runs-on: ubuntu-latest
    name: IaC Validation
    if: github.event.inputs.run_iac_lint == 'true' || github.event.inputs.run_iac_validate == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run IaC Linting
        if: github.event.inputs.run_iac_lint == 'true'
        run: |
          echo "ğŸ“ Running IaC linting..."
          # In a real scenario, you would use tools like 'az bicep lint' or 'tflint'
          echo "IaC linting passed."

      - name: Run IaC Validation
        if: github.event.inputs.run_iac_validate == 'true'
        run: |
          echo "â˜ï¸ Running IaC validation..."
          # In a real scenario, you would use 'az deployment group validate' or 'terraform validate'
          echo "IaC validation passed."

  app-checks:
    runs-on: ubuntu-latest
    name: Application Code Validation
    if: github.event.inputs.run_unit_test == 'true' || github.event.inputs.run_security_scan == 'true' || github.event.inputs.run_integration_test == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Unit Tests
        if: github.event.inputs.run_unit_test == 'true'
        run: |
          echo "ğŸ§ª Running unit tests..."

      - name: Run Security Scan
        if: github.event.inputs.run_security_scan == 'true'
        run: |
          echo "ğŸ”’ Running security scan..."

      - name: Run Integration Tests
        if: github.event.inputs.run_integration_test == 'true'
        run: |
          echo "ğŸ”— Running integration tests..."

  pre-deployment-summary:
    runs-on: ubuntu-latest
    name: Pre-Deployment Summary
    needs: [iac-checks, app-checks]
    if: always() # This job must always run to determine the final outcome
    steps:
      - name: Check job statuses
        run: |
          echo "IaC Checks status: ${{ needs.iac-checks.result }}"
          echo "App Checks status: ${{ needs.app-checks.result }}"
          if [[ "${{ needs.iac-checks.result }}" == "failure" || "${{ needs.iac-checks.result }}" == "cancelled" || "${{ needs.app-checks.result }}" == "failure" || "${{ needs.app-checks.result }}" == "cancelled" ]]; then
            echo "One or more pre-deployment checks failed."
            exit 1
          fi
          echo "All pre-deployment checks passed successfully."
