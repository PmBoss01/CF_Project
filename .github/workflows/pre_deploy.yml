
name: Pre-Deployment Checks

on:
  workflow_dispatch:
    inputs:
      run_unit_test:
        description: 'Run Unit Tests'
        required: false
        type: boolean
        default: false
      run_security_scan:
        description: 'Run Security Scan'
        required: false
        type: boolean
        default: false
      run_integration_test:
        description: 'Run Integration Tests'
        required: false
        type: boolean
        default: false
      run_iac_lint:
        description: 'Run IaC Linting'
        required: false
        type: boolean
        default: false
      run_iac_validate:
        description: 'Run IaC Validation'
        required: false
        type: boolean
        default: false

jobs:
  iac-checks:
    runs-on: ubuntu-latest
    name: IaC Validation
    if: github.event.inputs.run_iac_lint == 'true' || github.event.inputs.run_iac_validate == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Run IaC Linting
        if: github.event.inputs.run_iac_lint == 'true'
        run: |
          echo "ğŸ“ Installing and running tflint..."
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
          tflint --recursive

      - name: Run IaC Validation
        if: github.event.inputs.run_iac_validate == 'true'
        run: |
          echo "â˜ï¸ Running terraform validate..."
          terraform validate

  app-checks:
    runs-on: ubuntu-latest
    name: Application Code Validation
    if: github.event.inputs.run_unit_test == 'true' || github.event.inputs.run_security_scan == 'true' || github.event.inputs.run_integration_test == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Unit Tests
        if: github.event.inputs.run_unit_test == 'true'
        run: |
          echo "ğŸ§ª Running unit tests..."

      - name: Run Security Scan
        if: github.event.inputs.run_security_scan == 'true'
        run: |
          echo "ğŸ”’ Running security scan..."

      - name: Run Integration Tests
        if: github.event.inputs.run_integration_test == 'true'
        run: |
          echo "ğŸ”— Running integration tests..."
